<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clasificaci√≥n Taxon√≥mica - Biolog√≠a 10¬∞</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #2c203a; /* Fondo morado muy oscuro */
            color: #e2e8f0; /* Blanco suave para el texto principal */
            display: flex; /* Usar flexbox para el dise√±o */
            flex-direction: column; /* Apilar elementos verticalmente */
            min-height: 100vh; /* Asegurar que el cuerpo ocupe toda la altura de la ventana */
            padding: 8px; /* Padding general */
            align-items: center; /* Centrar horizontalmente el contenido principal */
        }
        .container {
            max-width: 900px;
            flex-grow: 1; /* Permitir que el contenedor principal ocupe el espacio disponible */
        }
        .bg-card {
            background-color: #4a3a5e; /* Un morado un poco m√°s claro para el contenido */
            border-radius: 2rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            padding: 2rem 3rem; /* Padding responsive */
            text-align: center;
            width: 100%; /* Asegurar que la tarjeta ocupe el 100% del ancho del contenedor */
        }
        .btn {
            background-color: #8b5cf6; /* Morado vibrante para los botones principales */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            font-weight: 700;
            transition: transform 0.2s, background-color 0.2s;
        }
        .btn:hover {
            background-color: #7c3aed;
            transform: scale(1.05);
        }
        .nav-btn {
            background-color: #a78bfa; /* Morado m√°s claro para los botones de navegaci√≥n */
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-weight: 600;
            transition: transform 0.2s, background-color 0.2s;
        }
        .nav-btn:hover {
            background-color: #8b5cf6;
            transform: scale(1.05);
        }
        /* Animaci√≥n de entrada general */
        .fade-in {
            animation: fadeIn 0.8s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Animaci√≥n para la "ruleta" de pausas activas */
        .roulette-reveal {
            animation: rouletteReveal 0.6s ease-out forwards; /* Animaci√≥n m√°s notoria */
        }
        @keyframes rouletteReveal {
            0% { opacity: 0; transform: scale(0.8) rotateX(-90deg); }
            50% { opacity: 0.5; transform: scale(1.05) rotateX(10deg); }
            100% { opacity: 1; transform: scale(1) rotateX(0deg); }
        }

        .loading-icon {
            display: none;
            color: #c4b5fd; /* Un morado suave para el icono de carga */
        }
        .text-highlight {
            color: #fcd34d; /* Amarillo para destacar texto importante, que contrasta bien con morado */
        }
        .quiz-option {
            background-color: #6d5b84; /* Morado m√°s oscuro para las opciones del quiz */
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.2s;
            text-align: left; /* Alineaci√≥n del texto de la opci√≥n */
            width: 100%; /* Ocupa todo el ancho disponible */
        }
        .quiz-option:hover {
            background-color: #4a3a5e;
            transform: scale(1.02);
        }
        .correct-answer {
            background-color: #34d399 !important; /* Verde menta para correcto */
            color: white;
        }
        .incorrect-answer {
            background-color: #ef4444 !important; /* Rojo para incorrecto */
            color: white;
        }
        /* Estilo espec√≠fico para la actividad de la semana */
        .activity-card {
            background-color: #6a5382; /* Un morado intermedio para la tarjeta de actividad */
            padding: 1.5rem;
            border-radius: 1.5rem;
            margin-top: 2rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            text-align: center;
        }
        .activity-icon {
            font-size: 3rem; /* Tama√±o grande para el icono */
            margin-bottom: 1rem;
            display: block; /* Para centrarlo bien */
        }
        .activity-title {
            color: #fcd34d; /* Amarillo para el t√≠tulo de la actividad */
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 0.75rem;
        }
        .activity-description {
            font-size: 1.15rem;
            line-height: 1.6;
        }
        .feedback-message {
            margin-top: 1rem;
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            font-weight: 600;
        }
        .feedback-correct {
            background-color: #10b981; /* Verde esmeralda */
            color: white;
        }
        .feedback-incorrect {
            background-color: #dc2626; /* Rojo fuerte */
            color: white;
        }
        /* Estilos para el formulario inicial */
        .form-input {
            background-color: #2d3748;
            border: 1px solid #4a3a5e;
            color: #e2e8f0;
            padding: 0.75rem;
            border-radius: 0.75rem;
            width: 100%;
            margin-bottom: 1rem;
        }
        .form-label {
            display: block;
            text-align: left;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        .footer {
            margin-top: auto; /* Empujar el pie de p√°gina hacia abajo */
            padding-top: 1rem;
            border-top: 1px solid #6a5382; /* Borde superior para separar del contenido */
            font-size: 0.9rem;
            color: #a78bfa; /* Morado claro para el texto del pie de p√°gina */
            text-align: center;
            width: 100%;
            max-width: 900px; /* Alineado con el contenedor principal */
            padding-bottom: 1rem; /* Espacio adicional en la parte inferior */
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #fff;
            width: 24px;
            height: 24px;
            -webkit-animation: spin 1s linear infinite; /* Safari */
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-left: 0.5rem;
        }

        /* Safari */
        @-webkit-keyframes spin {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-8">
    <div id="app" class="container bg-card fade-in">
        <!-- Contenido din√°mico aqu√≠ -->
    </div>

    <footer class="footer">
        <p>Creado por: Docente Karen Vanessa Salcedo A.</p>
    </footer>

    <script type="module">
        const appDiv = document.getElementById('app');
        let currentSection = 'home';
        let currentPausaActiva = null; 
        let studentData = {};
        let score = 0;
        let currentQuestionIndex = 0;

        // ** TU URL REAL DEL GOOGLE APPS SCRIPT DESPLEGADO **
        // ¬°NO LA CAMBIES A MENOS QUE VUELVAS A DESPLEGAR EL SCRIPT!
        const GOOGLE_SHEET_APP_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbytvGzpQd78jzb1g0_52LRKg-GTaVYj48uv10ex0BYJhW4R0bOCa7KVyrDtbfyf__51Eg/exec'; 

        // Array global de todas las pausas activas disponibles
        const allPausasActivas = [
            { title: "La Tortuga üê¢", text: "¬°Es momento de estirarnos! Ponte de pie y levanta los hombros hacia las orejas. Mant√©n la posici√≥n por 5 segundos y luego su√©ltalos, imaginando que tu cuello se alarga como el de una tortuga. Repite 3 veces. ¬°Ya est√°s listo para continuar!" },
            { title: "El B√∫ho ü¶â", text: "¬°Giremos la cabeza! Gira tu cabeza suavemente hacia la derecha, como si fueras un b√∫ho. Mant√©n por 5 segundos y luego haz lo mismo hacia la izquierda. Repite 3 veces en cada direcci√≥n para relajar los m√∫sculos del cuello. ¬°Tus ideas volar√°n con m√°s libertad!" },
            { title: "El Gato üòº", text: "¬°Es hora de estirar la espalda! Si√©ntate derecho, inhala profundamente y al exhalar, arquea la espalda hacia adelante, como un gato que se estira. Mant√©n por 5 segundos y vuelve a la posici√≥n inicial. Repite 3 veces. ¬°Tu columna te lo agradecer√°!" },
            { title: "El √°rbol üå≥", text: "¬°Vamos a enraizarnos! Lev√°ntate, junta los pies y siente el suelo. Balancea tu cuerpo de lado a lado suavemente, como un √°rbol movido por el viento. Si quieres, levanta una pierna y ap√≥yala en la otra para mantener el equilibrio." },
            { title: "El Drag√≥n üêâ", text: "¬°Imagina que eres un drag√≥n! Inhala profundamente por la nariz, expandiendo tu abdomen. Luego, exhala lentamente por la boca, imaginando que lanzas una llamarada. Repite 5 veces. Esta respiraci√≥n profunda te ayudar√° a oxigenar tu cerebro." },
            { title: "La Jirafa ü¶í", text: "¬°Vamos a estirar esos m√∫sculos! Entrelaza los dedos, estira los brazos por encima de la cabeza e inclina tu cuerpo de lado a lado. Siente c√≥mo se alarga tu torso. ¬°Estira tu cuello y tu espalda para crecer como una jirafa! Repite 3 veces." },
            { title: "La Medusa üåä", text: "¬°√öltima pausa activa del trimestre! Si√©ntate en el suelo, estira las piernas y balancea suavemente el torso de lado a lado. ¬°Siente la fluidez y la libertad de una medusa!" }
        ];

        // Preguntas de la evaluaci√≥n (10 puntos)
        const quizQuestions = [
            {
                question: "¬øQui√©n es conocido como el 'padre de la taxonom√≠a moderna'?",
                options: ["a) Charles Darwin", "b) Carl Linneo", "c) Gregor Mendel", "d) Isaac Newton"],
                correctAnswerIndex: 1,
                feedbackCorrect: "¬°Correcto! Carl Linneo estableci√≥ las bases de la taxonom√≠a moderna.",
                feedbackIncorrect: "Incorrecto. El padre de la taxonom√≠a moderna es Carl Linneo. √âl propuso el sistema de clasificaci√≥n jer√°rquico."
            },
            {
                question: "El nombre cient√≠fico <i>Canis lupus</i> hace referencia a un lobo. ¬øCu√°l de las siguientes categor√≠as taxon√≥micas se representa en este nombre?",
                options: ["a) Filo y Clase", "b) Reino y Familia", "c) G√©nero y Especie", "d) Orden y G√©nero"],
                correctAnswerIndex: 2,
                feedbackCorrect: "¬°Exacto! El nombre cient√≠fico se compone del G√©nero y la Especie (binominal).",
                feedbackIncorrect: "Incorrecto. El nombre cient√≠fico sigue la nomenclatura binominal, que usa el G√©nero y la Especie."
            },
            {
                question: "¬øQu√© diagrama muestra las relaciones evolutivas entre diferentes especies?",
                options: ["a) Pir√°mide alimenticia", "b) √Årbol filogen√©tico", "c) Mapa mental", "d) Diagrama de flujo"],
                correctAnswerIndex: 1,
                feedbackCorrect: "¬°As√≠ es! Un √°rbol filogen√©tico ilustra la historia evolutiva de los organismos.",
                feedbackIncorrect: "Incorrecto. El diagrama que muestra las relaciones evolutivas es el √°rbol filogen√©tico."
            },
            {
                question: "¬øCu√°l de los cinco reinos incluye organismos que son capaces de realizar fotos√≠ntesis y tienen c√©lulas eucariotas?",
                options: ["a) Fungi", "b) Plantae", "c) Animalia", "d) Monera"],
                correctAnswerIndex: 1,
                feedbackCorrect: "¬°Muy bien! El reino Plantae agrupa a los organismos fotosint√©ticos eucariotas.",
                feedbackIncorrect: "Incorrecto. El reino que cumple esas caracter√≠sticas es Plantae (las plantas)."
            },
            {
                question: "¬øCu√°l es el orden correcto de la jerarqu√≠a taxon√≥mica de Linneo, de mayor a menor?",
                options: ["a) Clase, Orden, Familia, G√©nero, Especie, Filo, Reino", "b) Reino, Filo, Clase, Orden, Familia, G√©nero, Especie", "c) Especie, G√©nero, Familia, Orden, Clase, Filo, Reino", "d) Filo, Reino, Clase, Orden, Familia, G√©nero, Especie"],
                correctAnswerIndex: 1,
                feedbackCorrect: "¬°Excelente! Reino, Filo, Clase, Orden, Familia, G√©nero y Especie es la secuencia correcta.",
                feedbackIncorrect: "Incorrecto. Recuerda el mnemot√©cnico: Rey Felipe Comi√≥ Ostras Finas, Gracias a su Esposa."
            },
            {
                question: "¬øQu√© caracter√≠stica define principalmente al reino Fungi?",
                options: ["a) Son aut√≥trofos y realizan fotos√≠ntesis.", "b) Son procariotas y unicelulares.", "c) Son heter√≥trofos y absorben nutrientes.", "d) Son pluricelulares y se mueven activamente."],
                correctAnswerIndex: 2,
                feedbackCorrect: "¬°Correcto! Los hongos son heter√≥trofos y obtienen nutrientes por absorci√≥n.",
                feedbackIncorrect: "Incorrecto. El reino Fungi (hongos) se caracteriza por ser heter√≥trofo y absorber nutrientes."
            },
            {
                question: "¬øQu√© es un 'clado' en un cladograma?",
                options: ["a) Una especie extinta.", "b) Un grupo de organismos que comparten un ancestro com√∫n.", "c) Una rama sin ramificaciones.", "d) Un organismo que no tiene relaci√≥n con otros."],
                correctAnswerIndex: 1,
                feedbackCorrect: "¬°Muy bien! Un clado representa un grupo monofil√©tico, es decir, un ancestro y todos sus descendientes.",
                feedbackIncorrect: "Incorrecto. Un clado es un grupo de organismos que incluye a un ancestro com√∫n y a todos sus descendientes."
            },
            {
                question: "¬øQu√© describe la evoluci√≥n convergente?",
                options: ["a) Especies cercanas que desarrollan diferencias.", "b) Especies no relacionadas que desarrollan caracter√≠sticas similares por adaptaci√≥n a entornos parecidos.", "c) La extinci√≥n de m√∫ltiples especies al mismo tiempo.", "d) El origen de nuevas especies a partir de un ancestro com√∫n."],
                correctAnswerIndex: 1,
                feedbackCorrect: "¬°As√≠ es! La evoluci√≥n convergente es cuando especies distintas desarrollan rasgos parecidos debido a presiones ambientales similares.",
                feedbackIncorrect: "Incorrecto. La evoluci√≥n convergente ocurre cuando especies no relacionadas desarrollan caracter√≠sticas similares debido a adaptaciones a entornos parecidos."
            },
            {
                question: "Los reinos Monera y Protista se diferencian principalmente por:",
                options: ["a) Monera es multicelular, Protista es unicelular.", "b) Monera son eucariotas, Protista son procariotas.", "c) Monera son procariotas, Protista son eucariotas.", "d) Ambos son fotosint√©ticos."],
                correctAnswerIndex: 2,
                feedbackCorrect: "¬°Perfecto! Monera incluye procariotas (bacterias) y Protista incluye eucariotas unicelulares y algunas algas.",
                feedbackIncorrect: "Incorrecto. La principal diferencia es que Monera agrupa a los procariotas y Protista a los eucariotas unicelulares."
            },
            {
                question: "¬øCu√°l de las siguientes es una regla fundamental de la nomenclatura binominal?",
                options: ["a) El nombre del g√©nero siempre va en may√∫sculas.", "b) Ambos nombres deben ir en cursiva o subrayados.", "c) Solo el nombre de la especie va en cursiva.", "d) Puede usarse cualquier idioma para los nombres."],
                correctAnswerIndex: 1,
                feedbackCorrect: "¬°Correcto! Ambos, g√©nero y especie, se escriben en cursiva o se subrayan.",
                feedbackIncorrect: "Incorrecto. Una regla fundamental es que tanto el g√©nero como la especie deben ir en cursiva o subrayados."
            }
        ];

        // Funci√≥n para obtener una pausa activa aleatoria
        const getRandomPausaActiva = () => {
            const randomIndex = Math.floor(Math.random() * allPausasActivas.length);
            return allPausasActivas[randomIndex];
        };

        const pages = {
            'home': {
                content: () => `
                    <div class="fade-in">
                        <h1 class="text-3xl md:text-5xl font-bold mb-4 text-center text-highlight">¬°Bienvenido al mundo de la Taxonom√≠a! üå≥üî¨</h1>
                        <p class="text-lg md:text-xl mb-8">
                            Exploremos c√≥mo clasificamos a los seres vivos.
                        </p>
                        <div class="flex flex-col space-y-4 md:space-y-0 md:flex-row md:space-x-4 justify-center">
                            <button onclick="goToSection('week1')" class="btn">
                                Comenzar üöÄ
                            </button>
                            <button onclick="goToSection('studentInfoForm')" class="btn">
                                Evaluaci√≥n üß†
                            </button>
                        </div>
                    </div>
                `,
                textToRead: "¬°Bienvenido al mundo de la Taxonom√≠a! Exploremos c√≥mo clasificamos a los seres vivos."
            },
            'week1': {
                content: (pausa) => `
                    <div class="fade-in">
                        <h2 class="text-2xl md:text-4xl font-bold mb-4 text-highlight">Semana 1: ¬øPor qu√© clasificamos?</h2>
                        <p class="mb-4">
                            La clasificaci√≥n taxon√≥mica es como un gran √°rbol geneal√≥gico de la vida. Nos ayuda a organizar y entender las relaciones entre millones de especies. ¬°Es el lenguaje universal de la biolog√≠a! üåê
                        </p>
                        <p class="mb-6">
                            El padre de la taxonom√≠a moderna es Carl Linneo. √âl propuso un sistema de clasificaci√≥n jer√°rquico que usamos hasta hoy. üßî‚Äç‚ôÇÔ∏è
                        </div>
                        <div class="flex justify-center mb-6">
                            <img src="https://i0.wp.com/tuguiadeaprendizaje.co/wp-content/uploads/2021/10/Taller-la-clasificacion-taxonomica.webp?w=911&ssl=1" alt="Pir√°mide de la clasificaci√≥n taxon√≥mica" class="rounded-lg shadow-md max-w-full h-auto">
                        </div>
                        
                        <div id="activity-display" class="activity-card mt-6">
                            <span class="activity-icon">ü¶Å</span> <!-- Icono para la actividad -->
                            <h3 class="activity-title">Actividad de la Semana: ¬°Atr√©vete a descubrir!</h3>
                            <p class="activity-description">
                                Busca y clasifica taxon√≥micamente a tu animal o planta favorita. ¬°Atr√©vete a descubrir su identidad!
                            </p>
                        </div>

                        <div id="pausa-activa-display" class="mt-6 p-4 bg-purple-600/20 rounded-lg text-left roulette-reveal">
                            <h3 class="text-xl font-bold mb-2">Pausa Activa: <span id="pausa-activa-title">${pausa.title}</span></h3>
                            <p id="pausa-activa-text">${pausa.text}</p>
                            <button onclick="rerollPausaActiva()" class="nav-btn mt-4">
                                Girar otra Pausa üîÑ
                            </button>
                        </div>

                        <div class="flex justify-center mt-8 space-x-4">
                            <button onclick="playCurrentText()" id="audio-btn" class="nav-btn">
                                <span class="loading-icon hidden">Cargando...</span>
                                <span class="play-icon">Leer Texto üîä</span>
                            </button>
                            <button onclick="goToSection('week2')" class="nav-btn">
                                Siguiente ‚û°Ô∏è
                            </button>
                        </div>
                    </div>
                `,
                textToRead: (pausa) => `Semana 1: ¬øPor qu√© clasificamos? La clasificaci√≥n taxon√≥mica es como un gran √°rbol geneal√≥gico de la vida. Nos ayuda a organizar y entender las relaciones entre millones de especies. ¬°Es el lenguaje universal de la biolog√≠a! El padre de la taxonom√≠a moderna es Carl Linneo. √âl propuso un sistema de clasificaci√≥n jer√°rquico que usamos hasta hoy. Actividad de la Semana: Busca y clasifica taxon√≥micamente a tu animal o planta favorita. ¬°Atr√©vete a descubrir su identidad! Pausa Activa: ${pausa.title}. ${pausa.text}`
            },
            'week2': {
                content: (pausa) => `
                    <div class="fade-in">
                        <h2 class="text-2xl md:text-4xl font-bold mb-4 text-highlight">Semana 2: La jerarqu√≠a de Linneo</h2>
                        <p class="mb-4">
                            ¬øRecuerdas el truco para aprender la jerarqu√≠a? 
                            <span class="font-bold text-yellow-300">R</span>ey <span class="font-bold text-yellow-300">F</span>elipe <span class="font-bold text-yellow-300">C</span>omi√≥ <span class="font-bold text-yellow-300">O</span>stras <span class="font-bold text-yellow-300">F</span>inas, <span class="font-bold text-yellow-300">G</span>racias a su <span class="font-bold text-yellow-300">E</span>sposa.üëë
                        </p>
                        <p class="mb-6">
                            Esto representa el orden: Reino, Filo, Clase, Orden, Familia, G√©nero y Especie. Es como el C√©dula de Ciudadan√≠a de cada ser vivo. üÜî
                        </div>
                        <div class="flex justify-center mb-6">
                            <img src="https://www.investiciencias.com/images/imagenes/claves%20taxonomicas.jpg" alt="Jerarqu√≠a Taxon√≥mica" class="rounded-lg shadow-md max-w-full h-auto">
                        </div>
                        
                        <div id="activity-display" class="activity-card mt-6">
                            <span class="activity-icon">üîé</span> <!-- Icono para la actividad -->
                            <h3 class="activity-title">Actividad de la Semana: ¬°Clasifica tu favorito!</h3>
                            <p class="activity-description">
                                Busca y clasifica taxon√≥micamente a tu animal o planta favorita. ¬°Atr√©vete a descubrir su identidad!
                            </p>
                        </div>

                        <div id="pausa-activa-display" class="mt-6 p-4 bg-purple-600/20 rounded-lg text-left roulette-reveal">
                            <h3 class="text-xl font-bold mb-2">Pausa Activa: <span id="pausa-activa-title">${pausa.title}</span></h3>
                            <p id="pausa-activa-text">${pausa.text}</p>
                            <button onclick="rerollPausaActiva()" class="nav-btn mt-4">
                                Girar otra Pausa üîÑ
                            </button>
                        </div>

                        <div class="flex justify-between mt-8">
                            <button onclick="goToSection('week1')" class="nav-btn">
                                ‚¨ÖÔ∏è Anterior
                            </button>
                            <button onclick="playCurrentText()" id="audio-btn" class="nav-btn">
                                <span class="loading-icon hidden">Cargando...</span>
                                <span class="play-icon">Leer Texto üîä</span>
                            </button>
                            <button onclick="goToSection('week3')" class="nav-btn">
                                Siguiente semana ‚û°Ô∏è
                            </button>
                        </div>
                    </div>
                `,
                textToRead: (pausa) => `Semana 2: La jerarqu√≠a de Linneo. ¬øRecuerdas el truco para aprender la jerarqu√≠a? Rey Felipe Comi√≥ Ostras Finas, Gracias a su Esposa. Esto representa el orden: Reino, Filo, Clase, Orden, Familia, G√©nero y Especie. Es como el C√©dula de Ciudadan√≠a de cada ser vivo. Actividad de la Semana: Busca y clasifica taxon√≥micamente a tu animal o planta favorita. ¬°Atr√©vete a descubrir su identidad! Pausa Activa: ${pausa.title}. ${pausa.text}`
            },
            'week3': {
                content: (pausa) => `
                    <div class="fade-in">
                        <h2 class="text-2xl md:text-4xl font-bold mb-4 text-highlight">Semana 3: Nomenclatura binominal</h2>
                        <p class="mb-4">
                            Cada especie tiene un nombre cient√≠fico √∫nico, como su apellido y nombre. ¬°Es su identidad universal! üåç
                        </p>
                        <p class="mb-6">
                            Este nombre se compone del G√©nero y la especie. Por ejemplo, nosotros somos <i>Homo sapiens</i>. Ambos nombres siempre van en cursiva. ü§ì
                        </div>
                        <div class="flex justify-center mb-6">
                            <img src="https://www.lifeder.com/wp-content/uploads/2018/05/canis-lupus-lobo-esquema-696x392.jpg" alt="Nomenclatura Binominal" class="rounded-lg shadow-md max-w-full h-auto">
                        </div>
                        
                        <div id="activity-display" class="activity-card mt-6">
                            <span class="activity-icon">üìù</span> <!-- Icono para la actividad -->
                            <h3 class="activity-title">Actividad de la Semana: ¬°Nombres cient√≠ficos!</h3>
                            <p class="activity-description">
                                Crea una lista de 5 seres vivos y escribe su nombre cient√≠fico. Investiga su significado.
                            </p>
                        </div>

                        <div id="pausa-activa-display" class="mt-6 p-4 bg-purple-600/20 rounded-lg text-left roulette-reveal">
                            <h3 class="text-xl font-bold mb-2">Pausa Activa: <span id="pausa-activa-title">${pausa.title}</span></h3>
                            <p id="pausa-activa-text">${pausa.text}</p>
                            <button onclick="rerollPausaActiva()" class="nav-btn mt-4">
                                Girar otra Pausa üîÑ
                            </button>
                        </div>

                        <div class="flex justify-between mt-8">
                            <button onclick="goToSection('week2')" class="nav-btn">
                                ‚¨ÖÔ∏è Anterior
                            </button>
                            <button onclick="playCurrentText()" id="audio-btn" class="nav-btn">
                                <span class="loading-icon hidden">Cargando...</span>
                                <span class="play-icon">Leer Texto üîä</span>
                            </button>
                            <button onclick="goToSection('week4')" class="nav-btn">
                                Siguiente ‚û°Ô∏è
                            </button>
                        </div>
                    </div>
                `,
                textToRead: (pausa) => `Semana 3: Nomenclatura binominal. Cada especie tiene un nombre cient√≠fico √∫nico, como su apellido y nombre. ¬°Es su identidad universal! Este nombre se compone del G√©nero y la especie. Por ejemplo, nosotros somos Homo sapiens. Ambos nombres siempre van en cursiva. Actividad de la Semana: Crea una lista de 5 seres vivos y escribe su nombre cient√≠fico. Investiga su significado. Pausa Activa: ${pausa.title}. ${pausa.text}`
            },
            'week4': {
                content: (pausa) => `
                    <div class="fade-in">
                        <h2 class="text-2xl md:text-4xl font-bold mb-4 text-highlight">Semana 4: Los cinco reinos</h2>
                        <p class="mb-4">
                            Todos los seres vivos se agrupan en grandes reinos: <span class="text-purple-300">Monera</span>, <span class="text-orange-300">Protista</span>, <span class="text-green-300">Fungi</span>, <span class="text-teal-300">Plantae</span> y <span class="text-red-300">Animalia</span>. üçÑüåøü¶Åü¶†
                        </p>
                        <p class="mb-6">
                            Cada reino tiene caracter√≠sticas √∫nicas. Por ejemplo, el reino Plantae es capaz de hacer fotos√≠ntesis, mientras que el reino Animalia no. üå±
                        </div>
                        <div class="flex justify-center mb-6">
                            <img src="https://i.ytimg.com/vi/rDCfusfkCVg/maxresdefault.jpg?sqp=-oaymwEmCIAKENAF8quKqQMa8AEB-AHUBoAC4AOKAgwIABABGGUgWShUMA8=&rs=AOn4CLC-a-lwf4izW58KNxewqmTDZxpbfA" alt="Los Cinco Reinos" class="rounded-lg shadow-md max-w-full h-auto">
                        </div>
                        
                        <div id="activity-display" class="activity-card mt-6">
                            <span class="activity-icon">üÉè</span> <!-- Icono para la actividad -->
                            <h3 class="activity-title">Actividad de la Semana: ¬°Juego de Reinos!</h3>
                            <p class="activity-description">
                                ¬°Crea tu propio juego de cartas con los 5 reinos! Dise√±a una carta para cada reino con sus principales caracter√≠sticas.
                            </p>
                        </div>

                        <div id="pausa-activa-display" class="mt-6 p-4 bg-purple-600/20 rounded-lg text-left roulette-reveal">
                            <h3 class="text-xl font-bold mb-2">Pausa Activa: <span id="pausa-activa-title">${pausa.title}</span></h3>
                            <p id="pausa-activa-text">${pausa.text}</p>
                            <button onclick="rerollPausaActiva()" class="nav-btn mt-4">
                                Girar otra Pausa üîÑ
                            </button>
                        </div>

                        <div class="flex justify-between mt-8">
                            <button onclick="goToSection('week3')" class="nav-btn">
                                ‚¨ÖÔ∏è Anterior
                            </button>
                            <button onclick="playCurrentText()" id="audio-btn" class="nav-btn">
                                <span class="loading-icon hidden">Cargando...</span>
                                <span class="play-icon">Leer Texto üîä</span>
                            </button>
                            <button onclick="goToSection('week5')" class="nav-btn">
                                Siguiente semana ‚û°Ô∏è
                            </button>
                        </div>
                    </div>
                `,
                textToRead: (pausa) => `Semana 4: Los cinco reinos. Todos los seres vivos se agrupan en grandes reinos: Monera, Protista, Fungi, Plantae y Animalia. Cada reino tiene caracter√≠sticas √∫nicas. Por ejemplo, el reino Plantae es capaz de hacer fotos√≠ntesis, mientras que el reino Animalia no. Actividad de la Semana: ¬°Crea tu propio juego de cartas con los 5 reinos! Dise√±a una carta para cada reino con sus principales caracter√≠sticas. Pausa Activa: ${pausa.title}. ${pausa.text}`
            },
            'week5': {
                content: (pausa) => `
                    <div class="fade-in">
                        <h2 class="text-2xl md:text-4xl font-bold mb-4 text-highlight">Semana 5: √Årbol Filogen√©tico</h2>
                        <p class="mb-4">
                            El estudio de las relaciones evolutivas entre los organismos se llama **filogenia**. Para representar estas relaciones, los cient√≠ficos utilizan diagramas como los **√°rboles filogen√©ticos**.
                        </p>
                        <p class="mb-6">
                            Un √°rbol filogen√©tico muestra la historia evolutiva de un grupo de especies. Las ramas representan los linajes y los nodos son los ancestros comunes. 
                        </div>
                        <div class="flex justify-center mb-6">
                            <img src="https://cdn.goconqr.com/uploads/media/image/28198773/desktop_ba371ffc-ba72-4fc7-8728-1e9de276ffbe.jpg" alt="√Årbol Filogen√©tico" class="rounded-lg shadow-md max-w-full h-auto">
                        </div>
                        
                        <div id="activity-display" class="activity-card mt-6">
                            <span class="activity-icon">üñçÔ∏è</span> <!-- Icono para la actividad -->
                            <h3 class="activity-title">Actividad de la Semana: ¬°Dibuja tu √°rbol!</h3>
                            <p class="activity-description">
                                Dibuja un √°rbol filogen√©tico simple de tres especies de animales que conozcas, indicando sus similitudes y diferencias.
                            </p>
                        </div>

                        <div id="pausa-activa-display" class="mt-6 p-4 bg-purple-600/20 rounded-lg text-left roulette-reveal">
                            <h3 class="text-xl font-bold mb-2">Pausa Activa: <span id="pausa-activa-title">${pausa.title}</span></h3>
                            <p id="pausa-activa-text">${pausa.text}</p>
                            <button onclick="rerollPausaActiva()" class="nav-btn mt-4">
                                Girar otra Pausa üîÑ
                            </button>
                        </div>

                        <div class="flex justify-between mt-8">
                            <button onclick="goToSection('week4')" class="nav-btn">
                                ‚¨ÖÔ∏è Anterior
                            </button>
                            <button onclick="playCurrentText()" id="audio-btn" class="nav-btn">
                                <span class="loading-icon hidden">Cargando...</span>
                                <span class="play-icon">Leer Texto üîä</span>
                            </button>
                            <button onclick="goToSection('week6')" class="nav-btn">
                                Siguiente semana ‚û°Ô∏è
                            </button>
                        </div>
                    </div>
                `,
                textToRead: (pausa) => `Semana 5: √Årbol Filogen√©tico. El estudio de las relaciones evolutivas entre los organismos se llama filogenia. Para representar estas relaciones, los cient√≠ficos utilizan diagramas como los √°rboles filogen√©ticos. Un √°rbol filogen√©tico muestra la historia evolutiva de un grupo de especies. Las ramas representan los linajes y los nodos son los ancestros comunes. Actividad de la Semana: Dibuja un √°rbol filogen√©tico simple de tres especies de animales que conozcas, indicando sus similitudes y diferencias. Pausa Activa: ${pausa.title}. ${pausa.text}`
            },
            'week6': {
                content: (pausa) => `
                    <div class="fade-in">
                        <h2 class="text-2xl md:text-4xl font-bold mb-4 text-highlight">Semana 6: Clados y Cladogramas</h2>
                        <p class="mb-4">
                            Un cladograma es un diagrama que muestra las relaciones evolutivas entre diferentes especies. ¬°Es como el mapa de la evoluci√≥n! üó∫Ô∏è
                        </p>
                        <p class="mb-6">
                            Cada rama en un cladograma se llama "clado", que representa un grupo de organismos que comparten un ancestro com√∫n. 
                        </div>
                        <div class="flex justify-center mb-6">
                            <img src="https://images.edrawsoft.com/es/2025/cladogram-construction.jpg" alt="Ejemplo de Cladograma" class="rounded-lg shadow-md max-w-full h-auto">
                        </div>
                        
                        <div id="activity-display" class="activity-card mt-6">
                            <span class="activity-icon">üåø</span> <!-- Icono para la actividad -->
                            <h3 class="activity-title">Actividad de la Semana: ¬°Crea tu cladograma!</h3>
                            <p class="activity-description">
                                Con ayuda de tu docente, intenta crear un cladograma con los animales de tu regi√≥n. ¬°Ser√° muy divertido!
                            </p>
                        </div>

                        <div id="pausa-activa-display" class="mt-6 p-4 bg-purple-600/20 rounded-lg text-left roulette-reveal">
                            <h3 class="text-xl font-bold mb-2">Pausa Activa: <span id="pausa-activa-title">${pausa.title}</span></h3>
                            <p id="pausa-activa-text">${pausa.text}</p>
                            <button onclick="rerollPausaActiva()" class="nav-btn mt-4">
                                Girar otra Pausa üîÑ
                            </button>
                        </div>

                        <div class="flex justify-between mt-8">
                            <button onclick="goToSection('week5')" class="nav-btn">
                                ‚¨ÖÔ∏è Anterior
                            </button>
                            <button onclick="playCurrentText()" id="audio-btn" class="nav-btn">
                                <span class="loading-icon hidden">Cargando...</span>
                                <span class="play-icon">Leer Texto üîä</span>
                            </button>
                            <button onclick="goToSection('week7')" class="nav-btn">
                                Siguiente semana ‚û°Ô∏è
                            </button>
                        </div>
                    </div>
                `,
                textToRead: (pausa) => `Semana 6: Clados y Cladogramas. Un cladograma es un diagrama que muestra las relaciones evolutivas entre diferentes especies. ¬°Es como el mapa de la evoluci√≥n! Cada rama en un cladograma se llama 'clado', que representa un grupo de organismos que comparten un ancestro com√∫n. Actividad de la Semana: Con ayuda de tu docente, intenta crear un cladograma con los animales de tu regi√≥n. ¬°Ser√° muy divertido! Pausa Activa: ${pausa.title}. ${pausa.text}`
            },
            'week7': {
                content: (pausa) => `
                    <div class="fade-in">
                        <h2 class="text-2xl md:text-4xl font-bold mb-4 text-highlight">Semana 7: Evoluci√≥n Convergente</h2>
                        <p class="mb-4">
                            La **evoluci√≥n convergente** es un proceso en el que dos especies que no est√°n estrechamente relacionadas desarrollan caracter√≠sticas similares de forma independiente, como resultado de adaptarse a ambientes o nichos ecol√≥gicos parecidos.
                        </p>
                        <p class="mb-6">
                            Esto puede llevar a que los organismos parezcan m√°s emparentados de lo que realmente son. Piensa en las alas de un murci√©lago y las de un insecto. Son similares en funci√≥n (volar) pero no en origen evolutivo. ¬°Eso es convergencia! ü¶á
                        </div>
                        <div class="flex justify-center mb-6">
                            <img src="https://pm1.aminoapps.com/6334/cbf9fd90a173ba889a043e61c0932cf4e97056a2_hq.jpg" alt="Evoluci√≥n Convergente" class="rounded-lg shadow-md max-w-full h-auto">
                        </div>
                        
                        <div id="activity-display" class="activity-card mt-6">
                            <span class="activity-icon">üßê</span> <!-- Icono para la actividad -->
                            <h3 class="activity-title">Actividad de la Semana: ¬°Investiga la evoluci√≥n!</h3>
                            <p class="activity-description">
                                Investiga y describe un ejemplo de evoluci√≥n convergente y uno de divergente.
                            </p>
                        </div>

                        <div id="pausa-activa-display" class="mt-6 p-4 bg-purple-600/20 rounded-lg text-left roulette-reveal">
                            <h3 class="text-xl font-bold mb-2">Pausa Activa: <span id="pausa-activa-title">${pausa.title}</span></h3>
                            <p id="pausa-activa-text">${pausa.text}</p>
                            <button onclick="rerollPausaActiva()" class="nav-btn mt-4">
                                Girar otra Pausa üîÑ
                            </button>
                        </div>

                        <div class="flex justify-between mt-8">
                            <button onclick="goToSection('week6')" class="nav-btn">
                                ‚¨ÖÔ∏è Anterior
                            </button>
                            <button onclick="playCurrentText()" id="audio-btn" class="nav-btn">
                                <span class="loading-icon hidden">Cargando...</span>
                                <span class="play-icon">Leer Texto üîä</span>
                            </button>
                            <button onclick="goToSection('evaluation')" class="nav-btn">
                                A la Evaluaci√≥n ‚û°Ô∏è
                            </button>
                        </div>
                    </div>
                `,
                textToRead: (pausa) => `Semana 7: Evoluci√≥n Convergente. La evoluci√≥n convergente es un proceso en el que dos especies que no est√°n estrechamente relacionadas desarrollan caracter√≠sticas similares de forma independiente, como resultado de adaptarse a ambientes o nichos ecol√≥gicos parecidos. Esto puede llevar a que los organismos parezcan m√°s emparentados de lo que realmente son. Piensa en las alas de un murci√©lago y las de un insecto. Son similares en funci√≥n (volar) pero no en origen evolutivo. ¬°Eso es convergencia! Actividad de la Semana: Investiga y describe un ejemplo de evoluci√≥n convergente y uno de divergente. Pausa Activa: ${pausa.title}. ${pausa.text}`
            },
            'studentInfoForm': {
                content: () => `
                    <div class="fade-in text-left">
                        <h2 class="text-3xl md:text-4xl font-bold mb-6 text-highlight text-center">Datos del Estudiante üìù</h2>
                        <form id="student-info-form" onsubmit="event.preventDefault(); submitStudentInfo();">
                            <div class="mb-4">
                                <label for="studentName" class="form-label">Nombre Completo:</label>
                                <input type="text" id="studentName" class="form-input" required>
                            </div>
                            <div class="mb-4">
                                <label for="studentCourse" class="form-label">Curso:</label>
                                <input type="text" id="studentCourse" class="form-input" required>
                            </div>
                            <div class="mb-6">
                                <label for="studentId" class="form-label">N√∫mero de Identificaci√≥n:</label>
                                <input type="text" id="studentId" class="form-input" required>
                            </div>
                            <div class="text-center">
                                <button type="submit" class="btn">
                                    Comenzar Evaluaci√≥n ‚ñ∂Ô∏è
                                </button>
                            </div>
                        </form>
                    </div>
                `,
                textToRead: "Formulario de Datos del Estudiante. Por favor, ingresa tu nombre completo, curso y n√∫mero de identificaci√≥n para comenzar la evaluaci√≥n."
            },
            'evaluation': {
                // El contenido de la evaluaci√≥n se generar√° din√°micamente con renderQuizQuestion
                content: (questionData) => `
                    <div class="fade-in text-left">
                        <h2 class="text-3xl md:text-4xl font-bold mb-6 text-highlight text-center">Evaluaci√≥n de Taxonom√≠a</h2>
                        <p class="text-xl mb-4 text-center">Pregunta ${currentQuestionIndex + 1} de ${quizQuestions.length}</p>
                        <div class="mb-6">
                            <p class="font-bold text-lg mb-4">${questionData.question}</p>
                            <div class="flex flex-col space-y-3" id="quiz-options">
                                ${questionData.options.map((option, index) => `
                                    <button class="quiz-option" onclick="checkAnswer(this, ${currentQuestionIndex}, ${index})">
                                        ${option}
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                        <div id="feedback-area" class="hidden text-center">
                            <p id="feedback-message" class="feedback-message"></p>
                            <button onclick="nextQuestion()" class="btn mt-4">
                                ${currentQuestionIndex < quizQuestions.length - 1 ? 'Siguiente Pregunta ‚û°Ô∏è' : 'Ver Resultados üèÜ'}
                            </button>
                        </div>
                    </div>
                `,
                textToRead: (questionData) => `Pregunta ${currentQuestionIndex + 1} de ${quizQuestions.length}: ${questionData.question}. Opciones: ${questionData.options.join(', ')}.`
            },
            'quizResults': {
                content: () => `
                    <div class="fade-in text-center">
                        <h2 class="text-3xl md:text-4xl font-bold mb-6 text-highlight">¬°Evaluaci√≥n Terminada! üéâ</h2>
                        <div class="text-lg mb-4">
                            <p><strong>Nombre:</strong> ${studentData.name}</p>
                            <p><strong>Curso:</strong> ${studentData.course}</p>
                            <p><strong>Identificaci√≥n:</strong> ${studentData.id}</p>
                        </div>
                        <p class="text-2xl font-bold mb-8">Tu puntaje final es: <span class="text-yellow-300">${score} / ${quizQuestions.length}</span></p>
                        <div id="saving-feedback" class="mt-4 text-base text-purple-200 flex items-center justify-center">
                            <span class="spinner hidden mr-2"></span>
                            <span>Guardando resultados...</span>
                        </div>
                        <button onclick="goToSection('home')" class="btn mt-6">
                            Volver al Inicio üè†
                        </button>
                    </div>
                `,
                textToRead: (results) => `Evaluaci√≥n Terminada. Nombre: ${studentData.name}. Curso: ${studentData.course}. Identificaci√≥n: ${studentData.id}. Tu puntaje final es: ${score} de ${quizQuestions.length}.`
            }
        };
        
        // Funci√≥n para renderizar el contenido basado en la secci√≥n actual
        const render = () => {
            console.log(`Renderizando secci√≥n: ${currentSection}`);
            const pageData = pages[currentSection];
            let contentToRender = '';

            if (typeof pageData.content === 'function') {
                if (currentSection.startsWith('week')) {
                    currentPausaActiva = getRandomPausaActiva(); 
                    contentToRender = pageData.content(currentPausaActiva);
                } else if (currentSection === 'evaluation') {
                    contentToRender = pageData.content(quizQuestions[currentQuestionIndex]);
                } else if (currentSection === 'quizResults') {
                    contentToRender = pageData.content(); 
                } else {
                    currentPausaActiva = null; 
                    contentToRender = pageData.content(); 
                }
            } else {
                contentToRender = pageData.content;
            }
            
            appDiv.innerHTML = contentToRender;

            const audioBtn = document.getElementById('audio-btn');
            if(audioBtn) {
                audioBtn.querySelector('.loading-icon').classList.add('hidden');
                audioBtn.querySelector('.play-icon').classList.remove('hidden');
            }
            console.log(`Secci√≥n ${currentSection} renderizada.`);

            // NEW LOGIC HERE: Initiate data saving if we just rendered quizResults
            if (currentSection === 'quizResults') {
                initiateDataSaving();
            }
        };

        // Nueva funci√≥n para iniciar el proceso de guardado una vez que la p√°gina de resultados est√° visible
        const initiateDataSaving = async () => {
            console.log("Iniciando proceso de guardado de datos.");
            const savingFeedback = document.getElementById('saving-feedback');
            // Acceso seguro al spinner, ya que savingFeedback ahora deber√≠a existir
            const spinner = savingFeedback ? savingFeedback.querySelector('.spinner') : null; 

            if (savingFeedback) {
                savingFeedback.classList.remove('hidden');
            }
            if (spinner) {
                spinner.classList.remove('hidden');
            }

            try {
                await sendDataToGoogleSheets(studentData.name, studentData.course, studentData.id, score);
                console.log("Datos enviados a Google Sheets con √©xito.");
            } catch (error) {
                console.error("Error al enviar datos a Google Sheets desde initiateDataSaving:", error);
                // Aqu√≠ podr√≠as mostrar un mensaje de error persistente en la interfaz si es necesario
            } finally {
                if (spinner) {
                    spinner.classList.add('hidden');
                }
                if (savingFeedback) {
                    // Mostrar un mensaje de "guardado" o "error" y luego ocultar
                    const feedbackTextSpan = savingFeedback.querySelector('span:not(.spinner)');
                    if (feedbackTextSpan) { // Asegurarse de que el span exista
                        feedbackTextSpan.textContent = 'Resultados guardados.';
                        if (feedbackTextSpan.textContent.includes('Error')) {
                             feedbackTextSpan.classList.add('text-red-400'); // Estilo para errores
                        } else {
                             feedbackTextSpan.classList.remove('text-red-400');
                        }
                    }
                    
                    setTimeout(() => { // Ocultar despu√©s de un breve retraso
                        savingFeedback.classList.add('hidden');
                        if (feedbackTextSpan) {
                            feedbackTextSpan.textContent = 'Guardando resultados...'; // Resetear texto para futuras ejecuciones
                            feedbackTextSpan.classList.remove('text-red-400'); // Quitar estilo de error
                        }
                    }, 3000); // 3 segundos de visibilidad del mensaje final
                }
            }
        };


        window.goToSection = (sectionName) => {
            console.log(`Navegando a la secci√≥n: ${sectionName}`);
            currentSection = sectionName;
            render();
        };

        window.rerollPausaActiva = () => {
            console.log("Girando otra Pausa Activa...");
            const pausaDisplay = document.getElementById('pausa-activa-display');
            const pausaTitleSpan = document.getElementById('pausa-activa-title');
            const pausaTextP = document.getElementById('pausa-activa-text');
            const rerollBtn = pausaDisplay.querySelector('.nav-btn');

            if (rerollBtn) rerollBtn.disabled = true; 

            pausaDisplay.classList.remove('roulette-reveal');
            void pausaDisplay.offsetWidth; 

            currentPausaActiva = getRandomPausaActiva(); 

            setTimeout(() => {
                if (pausaTitleSpan) pausaTitleSpan.textContent = currentPausaActiva.title;
                if (pausaTextP) pausaTextP.textContent = currentPausaActiva.text;
                pausaDisplay.classList.add('roulette-reveal'); 
                if (rerollBtn) rerollBtn.disabled = false; 
                console.log("Nueva Pausa Activa cargada:", currentPausaActiva.title);
            }, 50); 
        };

        window.submitStudentInfo = () => {
            console.log("Intentando enviar informaci√≥n del estudiante...");
            const studentName = document.getElementById('studentName').value.trim();
            const studentCourse = document.getElementById('studentCourse').value.trim();
            const studentId = document.getElementById('studentId').value.trim();

            if (studentName && studentCourse && studentId) {
                studentData = {
                    name: studentName,
                    course: studentCourse,
                    id: studentId
                };
                score = 0; 
                currentQuestionIndex = 0; 
                console.log("Datos del estudiante guardados:", studentData);
                goToSection('evaluation'); 
            } else {
                console.warn("Faltan datos del estudiante.");
                const feedbackDiv = document.createElement('div');
                feedbackDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                feedbackDiv.innerHTML = `
                    <div class="bg-card p-8 rounded-lg shadow-lg text-center">
                        <p class="text-xl mb-4">Por favor, completa todos los campos para comenzar la evaluaci√≥n.</p>
                        <button class="btn" onclick="this.parentElement.parentElement.remove()">Entendido</button>
                    </div>
                `;
                document.body.appendChild(feedbackDiv);
            }
        };

        window.checkAnswer = (element, questionIndex, selectedOptionIndex) => {
            console.log(`Revisando respuesta para la pregunta ${questionIndex + 1}. Opci√≥n seleccionada: ${selectedOptionIndex}`);
            const currentQuestion = quizQuestions[questionIndex];
            const optionsContainer = document.getElementById('quiz-options');
            const feedbackArea = document.getElementById('feedback-area');
            const feedbackMessage = document.getElementById('feedback-message');
            const nextButton = feedbackArea.querySelector('.btn');

            Array.from(optionsContainer.children).forEach(btn => btn.disabled = true);

            feedbackArea.classList.remove('hidden');

            if (selectedOptionIndex === currentQuestion.correctAnswerIndex) {
                element.classList.add('correct-answer');
                feedbackMessage.textContent = currentQuestion.feedbackCorrect;
                feedbackMessage.classList.remove('feedback-incorrect');
                feedbackMessage.classList.add('feedback-correct');
                score++; 
                console.log(`Respuesta correcta. Puntaje actual: ${score}`);
            } else {
                element.classList.add('incorrect-answer');
                feedbackMessage.textContent = currentQuestion.feedbackIncorrect;
                feedbackMessage.classList.remove('feedback-correct');
                feedbackMessage.classList.add('feedback-incorrect');
                optionsContainer.children[currentQuestion.correctAnswerIndex].classList.add('correct-answer');
                console.log(`Respuesta incorrecta. Puntaje actual: ${score}`);
            }

            if (currentQuestionIndex === quizQuestions.length - 1) {
                 nextButton.textContent = 'Ver Resultados üèÜ';
                 console.log("√öltima pregunta. Bot√≥n Siguiente ahora dice 'Ver Resultados üèÜ'");
            } else {
                 nextButton.textContent = 'Siguiente Pregunta ‚û°Ô∏è';
                 console.log("No es la √∫ltima pregunta. Bot√≥n Siguiente ahora dice 'Siguiente Pregunta ‚û°Ô∏è'");
            }
            console.log("Feedback mostrado.");
        };
        
        window.nextQuestion = async () => {
            console.log("Funci√≥n nextQuestion() llamada.");
            currentQuestionIndex++;
            if (currentQuestionIndex < quizQuestions.length) {
                console.log(`Avanzando a la pregunta ${currentQuestionIndex + 1}.`);
                goToSection('evaluation');
            } else {
                console.log("Todas las preguntas respondidas. Navegando a la secci√≥n de resultados para iniciar el env√≠o.");
                // Ahora, simplemente navegamos a la secci√≥n de resultados.
                // La funci√≥n initiateDataSaving() se llamar√° autom√°ticamente despu√©s de que se renderice.
                goToSection('quizResults');
            }
        };

        const sendDataToGoogleSheets = async (name, course, id, finalScore) => {
            if (GOOGLE_SHEET_APP_SCRIPT_URL === '') { 
                console.error("ERROR: La 'GOOGLE_SHEET_APP_SCRIPT_URL' no est√° configurada.");
                const feedbackDiv = document.createElement('div');
                feedbackDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                feedbackDiv.innerHTML = `
                            <div class="bg-card p-8 rounded-lg shadow-lg text-center">
                                <p class="text-xl mb-4 text-red-400">Error: La URL del Google Apps Script no est√° configurada. Por favor, contacta al docente.</p>
                                <button class="btn" onclick="this.parentElement.parentElement.remove()">Entendido</button>
                            </div>
                        `;
                document.body.appendChild(feedbackDiv);
                throw new Error("URL de Apps Script no configurada."); 
            }

            const data = {
                timestamp: new Date().toLocaleString('es-CO'),
                name: name,
                course: course,
                id: id,
                score: finalScore,
                totalQuestions: quizQuestions.length
            };

            console.log("Datos a enviar:", data); 
            console.log("URL de Apps Script:", GOOGLE_SHEET_APP_SCRIPT_URL); 

            const MAX_RETRIES = 3;
            let retries = 0;
            let delay = 1000; 

            while (retries < MAX_RETRIES) {
                try {
                    const response = await fetch(GOOGLE_SHEET_APP_SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors', 
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: new URLSearchParams(data).toString()
                    });
                    
                    console.log("Intento exitoso de enviar datos al Google Sheet (modo 'no-cors').");
                    return; 
                } catch (error) {
                    console.error(`Intento ${retries + 1} de enviar datos al Google Sheet fall√≥:`, error);
                    retries++;
                    if (retries < MAX_RETRIES) {
                        console.log(`Reintentando en ${delay / 1000} segundos...`);
                        await new Promise(res => setTimeout(res, delay));
                        delay *= 2; 
                    } else {
                        console.error(`Error al enviar datos al Google Sheet despu√©s de ${MAX_RETRIES} intentos:`, error.message);
                        const feedbackDiv = document.createElement('div');
                        feedbackDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                        feedbackDiv.innerHTML = `
                            <div class="bg-card p-8 rounded-lg shadow-lg text-center">
                                <p class="text-xl mb-4 text-red-400">Error al guardar los resultados despu√©s de varios intentos. Por favor, int√©ntalo de nuevo o contacta al docente.</p>
                                <button class="btn" onclick="this.parentElement.parentElement.remove()">Entendido</button>
                            </div>
                        `;
                        document.body.appendChild(feedbackDiv);
                        throw error; 
                    }
                }
            }
        };

        const playTextToSpeech = async (text) => {
            const audioBtn = document.getElementById('audio-btn');
            if (!audioBtn) {
                console.warn("No se encontr√≥ el bot√≥n de audio para reproducir el texto.");
                return; 
            }

            const playIcon = audioBtn.querySelector('.play-icon');
            const loadingIcon = audioBtn.querySelector('.loading-icon');

            audioBtn.disabled = true;
            playIcon.classList.add('hidden');
            loadingIcon.classList.remove('hidden');
            console.log("Iniciando TTS para:", text.substring(0, 50) + "..."); 

            const payload = {
                contents: [{
                    parts: [{ text: text }]
                }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: { voiceName: "Kore" }
                    }
                },
                model: "gemini-2.5-flash-preview-tts"
            };

            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;

            const MAX_RETRIES = 3;
            let retries = 0;
            let delay = 1000; 

            while (retries < MAX_RETRIES) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        const part = result?.candidates?.[0]?.content?.parts?.[0];
                        const audioData = part?.inlineData?.data;
                        const mimeType = part?.inlineData?.mimeType;

                        if (audioData && mimeType && mimeType.startsWith("audio/")) {
                            let sampleRate;
                            const rateMatch = mimeType.match(/rate=(\d+)/);
                            if (rateMatch) {
                                sampleRate = parseInt(rateMatch[1], 10);
                            } else if (mimeType === 'audio/L16') {
                                sampleRate = 16000; 
                                console.warn("MimeType 'audio/L16' found without explicit rate. Defaulting to 16000 Hz sample rate.");
                            } else {
                                throw new Error(`Unsupported audio mimeType: ${mimeType}`);
                            }

                            const pcmData = base64ToArrayBuffer(audioData);
                            const pcm16 = new Int16Array(pcmData);
                            const wavBlob = pcmToWav(pcm16, sampleRate);
                            const audioUrl = URL.createObjectURL(wavBlob);
                            const audio = new Audio(audioUrl);
                            audio.play();
                            console.log("Audio TTS reproducido con √©xito.");
                            return; 
                        } else {
                            console.error("Faltan datos de audio o tipo MIME en la respuesta de la API de TTS.");
                            throw new Error("Missing audio data or MIME type in TTS API response.");
                        }
                    } else {
                        const errorBody = await response.text();
                        console.error(`Respuesta de la API de TTS no ok: ${response.status} - ${response.statusText}. Body: ${errorBody}`);
                        if (response.status >= 400 && response.status < 500) {
                            throw new Error(`Error de respuesta de la API de TTS: ${response.statusText}`);
                        }
                        throw new Error(`Error transitorio de la API de TTS: ${response.statusText}`);
                    }
                } catch (error) {
                    console.error(`Intento ${retries + 1} de TTS fall√≥:`, error);
                    retries++;
                    if (retries < MAX_RETRIES) {
                        await new Promise(res => setTimeout(res, delay));
                        delay *= 2; 
                    } else {
                        console.error(`Error al reproducir audio TTS despu√©s de ${MAX_RETRIES} intentos:`, error.message);
                        const feedbackDiv = document.createElement('div');
                        feedbackDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                        feedbackDiv.innerHTML = `
                            <div class="bg-card p-8 rounded-lg shadow-lg text-center">
                                <p class="text-xl mb-4 text-red-400">No se pudo reproducir el audio. Puede que haya un problema con el servicio de voz.</p>
                                <button class="btn" onclick="this.parentElement.parentElement.remove()">Entendido</button>
                            </div>
                        `;
                        document.body.appendChild(feedbackDiv);
                        return; 
                    }
                } finally {
                    audioBtn.disabled = false;
                    playIcon.classList.remove('hidden');
                    loadingIcon.classList.add('hidden');
                }
            }
        };

        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function pcmToWav(pcmData, sampleRate) {
            const pcmBuffer = pcmData.buffer;
            const numChannels = 1;
            const sampleBits = 16;
            const dataLength = pcmData.length * (sampleBits / 8);
            const buffer = new ArrayBuffer(44 + dataLength);
            const view = new DataView(buffer);

            let offset = 0;

            function writeString(view, offset, string) {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            }

            // RIFF chunk
            writeString(view, offset, 'RIFF'); offset += 4;
            view.setUint32(offset, 36 + dataLength, true); offset += 4;
            writeString(view, offset, 'WAVE'); offset += 4;

            // FMT chunk
            writeString(view, offset, 'fmt '); offset += 4;
            view.setUint32(offset, 16, true); offset += 4; // Tama√±o del chunk
            view.setUint16(offset, 1, true); offset += 2; // Formato de audio (1 = PCM)
            view.setUint16(offset, numChannels, true); offset += 2;
            view.setUint32(offset, sampleRate, true); offset += 4;
            view.setUint32(offset, sampleRate * numChannels * (sampleBits / 8), true); offset += 4;
            view.setUint16(offset, numChannels * (sampleBits / 8), true); offset += 2;
            view.setUint16(offset, sampleBits, true); offset += 2;

            // Data chunk
            writeString(view, offset, 'data'); offset += 4;
            view.setUint32(offset, dataLength, true); offset += 4;
            for (let i = 0; i < pcmData.length; i++) {
                view.setInt16(offset, pcmData[i], true);
                offset += 2;
            }

            return new Blob([view], { type: 'audio/wav' });
        }

        window.playCurrentText = () => {
            const pageData = pages[currentSection];
            if (pageData && pageData.textToRead) {
                let textToSpeak = '';
                if (currentSection.startsWith('week')) {
                    textToSpeak = pageData.textToRead(currentPausaActiva);
                } else if (currentSection === 'evaluation') {
                    textToSpeak = pageData.textToRead(quizQuestions[currentQuestionIndex]);
                } else if (currentSection === 'quizResults') {
                    textToSpeak = pageData.textToRead({ score, total: quizQuestions.length });
                } else {
                    textToSpeak = pageData.textToRead;
                }
                playTextToSpeech(textToSpeak);
            }
        };

        // Configuraci√≥n inicial
        window.onload = () => {
            goToSection('home');
        };
    </script>
</body>
</html>
